<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Buttonie</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="manifest" href="./site.webmanifest" />
    <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
    <!-- Generated with https://purgecss.com/api.html#usage -->
    <!-- <link rel="stylesheet" href="tachyons.min.css" /> -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css" /> -->
    <!-- TODO: minify paper -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/papercss@1.7.0/dist/paper.min.css"
    />
    <!-- <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
    /> -->
    <style>
      * {
        font-family: 'Neucha', sans-serif;
      }

      [x-cloak] {
        display: none;
      }
    </style>
    <script
      async
      src="https://cdn.jsdelivr.net/gh/aFarkas/lazysizes/lazysizes.min.js"
    ></script>
    <script async src="functions.js"></script>
    <script
      async
      type="module"
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.5.0/dist/alpine.min.js"
    ></script>
    <script
      defer
      nomodule
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.5.0/dist/alpine-ie11.min.js"
    ></script>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  </head>

  <!-- x-init="created(); checkHash()"
    @hashchange.window="checkHash()" -->

  <body
    x-cloak
    x-data="data()"
    x-init="created()"
    class="container margin-top-small padding-small"
  >
    <!-- Navigation and header -->
    <nav class="border split-nav">
      <div class="nav-brand">
        <h3><a href="/">Buttonie</a></h3>
      </div>
      <div class="collapsible">
        <input id="collapsible1" type="checkbox" name="collapsible1" />
        <label for="collapsible1">
          <div class="bar1"></div>
          <div class="bar2"></div>
          <div class="bar3"></div>
        </label>
        <div class="collapsible-body">
          <ul class="inline">
            <template x-for="(item, index) in navLinks" :key="index">
              <li>
                <a
                  :href="item.href"
                  :title="item.title"
                  x-text="item.title"
                ></a>
              </li>
            </template>
          </ul>
        </div>
      </div>
    </nav>

    <main class="paper border border-5 shadow shadow-small">
      <!-- Notifications & Conditional Sections -->
      <div
        style="display:none"
        class="padding-top-small padding-left padding-right"
      >
        <!-- Progress Bar -->
        <div class="progress margin-top-small margin-bottom-small">
          <div class="bar success w-50"></div>
        </div>
        <hr class="margin-top margin-bottom" />

        <!-- Alerts -->
        <div class="row flex-spaces">
          <input class="alert-state" id="alert-1" type="checkbox" />
          <div class="alert alert-secondary dismissible">
            Alert-secondary
            <label class="btn-close" for="alert-1">X</label>
          </div>
          <input class="alert-state" id="alert-2" type="checkbox" />
          <div class="alert alert-success dismissible">
            Alert-success
            <label class="btn-close" for="alert-2">X</label>
          </div>
        </div>
        <hr class="margin-top margin-bottom" />
      </div>

      <!-- Main Content -->
      <div
        x-show="!ingame"
        class="padding-top-small padding-left padding-right"
      >
        <h3 class="margin-none">Joining a Game</h3>
        <h5 class="text-secondary margin-top-small">Let's get Connected!</h5>

        <form id="join-game" class="padding" x-on:submit.prevent>
          <div class="form-group">
            <label for="roomcode">Room Code</label>
            <input
              type="text"
              placeholder="enter 4 letter code"
              onkeyup="this.value = this.value.toUpperCase()"
              x-model="roomcode"
            />
          </div>

          <div class="form-group">
            <label for="name">Name</label>
            <input
              type="text"
              placeholder="enter your name"
              x-model="username"
            />
          </div>

          <button
            @click="join()"
            :disabled="username.length < 1 || roomcode.length < 4"
            class="btn-secondary btn-block"
          >
            <h4 class="margin-none">Join</h4>
          </button>

          <button
            @click="host()"
            :disabled="username.length < 1 || roomcode.length < 4"
            class="btn-success btn-block margin-top-small"
          >
            <h4 class="margin-none">Host</h4>
          </button>
        </form>
      </div>
      <h3 class="margin-small">Message Output</h3>
      <div
        id="messages"
        class="background-warning padding"
        style="height:10rem; max-height: 10rem; overflow-y: scroll;"
      >
        <template x-for="(item, index) in messages" :key="index">
          <p class="text-danger margin-none" style="margin-top:8px;">
            <span
              style="font-size: 1rem;"
              class="badge"
              :class="{ 'secondary': index != 0 && item.from != username}"
              x-text="item.from + ' :'"
            ></span>
            <span x-text="item.data"></span>
          </p>
        </template>
      </div>

      <!-- Message form -->
      <form id="messsage" x-on:submit.prevent>
        <div class="form-group">
          <input
            autocomplete="off"
            type="text"
            class="border-6 border"
            placeholder="enter a message"
            x-model="message"
          />

          <button @click="sendMessage()" class="btn-warning">
            Send
          </button>
        </div>
      </form>

      <!-- IDK what this is -->
      <div x-show="ingame" class="paper container container-xs">
        <button id="onsort" class="background-secondary">Online</button>
        <button id="offsort" class="background-success">Offline</button>
        <button id="allsort" class="background-primary">All</button>
      </div>
    </main>
    <div x-show="isHost" class="row">
      <h3
        style="text-align: center;"
        class="col-12 col text-muted padding-none margin-none"
      >
        You are the host
      </h3>
    </div>
  </body>

  <script>
    function data () {
      return {
        // Dynamic Data
        messages: [
          {
            from: 'server',
            data: 'messages will show up here'
          }
        ],
        // Form Data
        roomcode: 'YEET', // for now room codes are just other's usernames
        username: '',
        message: '',
        // Status Data
        peer: null,
        connection: [],
        ingame: false,
        isHost: false,
        // Static data for convenience
        navLinks: [
          {
            title: 'Play',
            href: '#'
          },
          {
            title: 'About',
            href: '#'
          },
          {
            title: 'Github',
            href: 'https://github.com/Setherizor/buttonie'
          }
        ],

        // Functions

        // Ran on page load
        created () {},
        /**
         * Send message to all connections
         */
        broadcast (message, isReplay) {
          // Send existing package, or pack the data
          let payload = isReplay
            ? message
            : {
                from: this.username,
                data: message
              }

          this.connection
            .filter(c => c.metadata.username != message.from)
            .forEach(c => c.send(payload))
        },
        /**
         * As peer, just write to page
         * As host, repeat to all but sending peer
         */
        messageHandler (message) {
          if (this.isHost) this.broadcast(message, true)

          // Scroll down
          setTimeout(() => {
            let el = document.getElementById('messages')
            el.scrollTop = el.scrollHeight
          }, 100)
          this.messages.push(message)
        },
        /**
         * Setup listeners for connections
         * HOST & CLIENT
         */
        connectionHandler (conn) {
          // data is launched when you receive a message
          conn.on('data', data => this.messageHandler(data))

          // open is launched when you successfully connect to PeerServer
          conn.on('open', () =>
            this.broadcast(
              conn.metadata.username + ' has joined to ' + conn.peer
            )
          )

          // detect when a connection is closed (won't work in Firefox)
          conn.on('close', () => {
            console.log('Connection closed:', conn.label)
            this.broadcast(conn.metadata.username + ' has left')
          })

          // catch all
          conn.on('error', function (e) {
            console.log('Error with connection', e, this)
          })

          // Add to host's connections
          this.connection.push(conn)
        },
        /**
         * Join broker server with a given ID
         */
        broker (peerID) {
          if (!this.peer)
            this.peer = new Peer(peerID, {
              host: 'pi.sethp.cc',
              port: 9001,
              path: '/buttonie'
            })

          return new Promise((resolve, reject) => {
            this.peer.on('open', id => console.log('brokered:', id, this.peer))
            resolve()
          })
        },
        /**
         * Host a gameroom
         */
        async host () {
          let id = this.username
          let room = this.roomcode
          this.broker(room)

          // Setup incoming connection handler
          this.peer.on('connection', conn => this.connectionHandler(conn))

          this.isHost = true
          // this.ingame = true
        },
        /**
         * Join the gameroom
         */
        async join () {
          // Join the connection broker (PeerServer)
          let id = this.username
          let room = this.roomcode

          // Close current connections
          if (this.peer) this.peer.destroy()
          if (this.connection.length != 0) this.connection = []

          await this.broker(id + '-peer')

          let conn = this.peer.connect(this.roomcode, {
            label: id + '-connection',
            metadata: {
              username: id
            }
          })

          this.connectionHandler(conn)
          // this.ingame = true
          console.log('You have entered the game')
        },
        /**
         * send message to room if connected
         */
        sendMessage () {
          if (!this.peer) {
            alert('You have not connected to the broker')
            return
          }

          if (this.connection.length == 0) {
            alert('There is no one to send the message to')
            return
          }

          if (!this.message) {
            alert('Please type a message to send')
            return
          }

          // Send to connections
          this.broadcast(this.message)
          // Add local message
          this.messages.push({
            from: this.username,
            data: this.message
          })

          // Scroll down
          setTimeout(() => {
            let el = document.getElementById('messages')
            el.scrollTop = el.scrollHeight
          }, 100)

          this.message = ''
        }
      }
    }
  </script>
</html>
